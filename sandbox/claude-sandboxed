#!/bin/bash
# Claude Code in Docker sandbox
# https://github.com/nickmvincent/agentwatch
#
# Usage: claude-sandboxed [args]
# Example: claude-sandboxed --help
# Example: claude-sandboxed -p "explain this codebase"
#
# Installation:
#   1. Build image: docker build -t claude-sandbox path/to/sandbox/
#   2. Copy this script: cp claude-sandboxed ~/.local/bin/
#   3. Make executable: chmod +x ~/.local/bin/claude-sandboxed
#   4. Add to PATH: export PATH="$HOME/.local/bin:$PATH"
#
# Alias suggestion for ~/.zshrc:
#   alias cs='claude-sandboxed'

set -e

IMAGE_NAME="${CLAUDE_SANDBOX_IMAGE:-claude-sandbox}"

# Check Docker is running
if ! docker info &>/dev/null; then
    echo "Error: Docker is not running."
    echo ""
    echo "Start your Docker runtime:"
    echo "  Docker Desktop: open -a Docker"
    echo "  Colima:         colima start"
    echo "  OrbStack:       open -a OrbStack"
    exit 1
fi

# Check if image exists
if ! docker image inspect "$IMAGE_NAME" &>/dev/null; then
    echo "Error: Docker image '$IMAGE_NAME' not found."
    echo ""
    echo "Build the image first:"
    echo "  docker build -t claude-sandbox path/to/agentwatch/sandbox/"
    echo ""
    echo "Or use agentwatch:"
    echo "  agentwatch sandbox install"
    exit 1
fi

# Run Claude Code in container
# - Mounts current directory as /workspace
# - Mounts ~/.claude for settings/auth
# - Mounts ~/.agentwatch for hooks (read-only)
# - Passes through API keys
# - Uses bridge network (allows API calls, blocks localhost)
# - Interactive TTY for terminal UI

docker run -it --rm \
    -v "$(pwd):/workspace" \
    -v "$HOME/.claude:/home/claude/.claude" \
    -v "$HOME/.agentwatch:/home/claude/.agentwatch:ro" \
    -e ANTHROPIC_API_KEY \
    -e CLAUDE_CODE_USE_BEDROCK \
    -e CLAUDE_CODE_USE_VERTEX \
    -e AWS_ACCESS_KEY_ID \
    -e AWS_SECRET_ACCESS_KEY \
    -e AWS_SESSION_TOKEN \
    -e AWS_REGION \
    -e GOOGLE_APPLICATION_CREDENTIALS \
    --network bridge \
    "$IMAGE_NAME" --dangerously-skip-permissions "$@"
